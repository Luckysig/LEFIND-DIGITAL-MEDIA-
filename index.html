<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShortMyLink</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:linear-gradient(135deg,#4b6cb7,#182848);
      color:#fff; min-height:100vh;
      display:flex; justify-content:center; align-items:center;
      padding:1rem;
    }
    .panel {
      background:rgba(255,255,255,0.1);
      border-radius:16px; backdrop-filter:blur(10px);
      width:100%; max-width:400px; padding:2rem;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }
    h1{text-align:center;font-size:1.8rem;margin-bottom:1rem;letter-spacing:1px;}
    .input-group {margin-bottom:1rem;}
    .input-group label{display:block;font-size:.9rem;margin-bottom:.3rem;}
    .input-group input, .input-group select{
      width:100%;padding:.6rem;border:none;border-radius:8px;font-size:1rem;
    }
    .input-group input:focus, .input-group select:focus{outline:none;box-shadow:0 0 0 2px rgba(255,255,255,0.4);}
    .btn{width:100%;padding:.75rem;background:#ff4b5c;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:background .3s ease;}
    .btn:hover{background:#ff1e36;}
    .link-list{margin-top:1.5rem;max-height:300px;overflow-y:auto;}
    .link-item{
      background:rgba(255,255,255,0.2);padding:.5rem;margin-bottom:.6rem;
      border-radius:6px;font-size:.9rem;word-break:break-all;
      display:flex;flex-direction:column;
    }
    .link-info{
      display:flex;justify-content:space-between;align-items:center;cursor:pointer;
    }
    .link-info a{color:#ffe600; text-decoration:none; flex:1;}
    .actions{
      margin-top:.5rem;display:none;justify-content:flex-end;gap:.5rem;
    }
    .actions button{background:transparent;border:none;color:#ffe600;cursor:pointer;font-size:.8rem;}
    .loader{display:none;margin:1rem auto;border:4px solid rgba(255,255,255,0.3);border-top:4px solid #ffe600;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .error{color:#ffcccc;font-size:.85rem;text-align:center;}
    .spinner-screen{
      position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
      display:flex;justify-content:center;align-items:center;z-index:1000;visibility:hidden;
    }
    .spinner-screen.active{visibility:visible;}
    .qr-img{width:80px;height:80px;margin-right:.5rem;border-radius:4px;}
  </style>
</head>
<body>
  <div class="panel">
    <h1>ShortMyLink</h1>
    <div class="input-group">
      <label for="longUrl">Long URL</label>
      <input type="url" id="longUrl" placeholder="https://example.com/very/long/url">
    </div>
    <div class="input-group">
      <label for="customAlias">Custom Alias (optional)</label>
      <input type="text" id="customAlias" placeholder="myalias">
    </div>
    <div class="input-group">
      <label for="expiry">Expiry Date (optional)</label>
      <input type="date" id="expiry">
    </div>
    <div class="input-group">
      <label for="redirectType">Redirect Type</label>
      <select id="redirectType">
        <option value="302">Temporary (302)</option>
        <option value="301">Permanent (301)</option>
      </select>
    </div>
    <div class="input-group">
      <label><input type="checkbox" id="previewToggle"> Enable Preview Mode</label>
    </div>
    <div class="loader" id="loader"></div>
    <button class="btn" id="shortenBtn">Shorten URL</button>
    <p class="error" id="errorMsg"></p>
    <div class="link-list" id="linkList"></div>
  </div>
  <div class="spinner-screen" id="spinnerScreen">
    <div class="loader"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    const shortenBtn=document.getElementById('shortenBtn');
    const longUrlInput=document.getElementById('longUrl');
    const customAlias=document.getElementById('customAlias');
    const expiry=document.getElementById('expiry');
    const redirectType=document.getElementById('redirectType');
    const previewToggle=document.getElementById('previewToggle');
    const loader=document.getElementById('loader');
    const errorMsg=document.getElementById('errorMsg');
    const linkList=document.getElementById('linkList');
    const spinnerScreen=document.getElementById('spinnerScreen');

    shortenBtn.addEventListener('click',async()=>{
      errorMsg.textContent='';
      const url=longUrlInput.value.trim();
      if(!url) return errorMsg.textContent='Enter valid URL';
      const payload={ url, alias:customAlias.value.trim()||undefined, expiry:expiry.value||undefined, type:redirectType.value, preview:previewToggle.checked };
      loader.style.display='block'; shortenBtn.disabled=true;
      try{
        const res=await fetch('/api/shorten',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const text=await res.text(); let data;
        try{data=JSON.parse(text);}catch{throw new Error('Invalid JSON from server');}
        if(!res.ok) throw new Error(data.message||'Shorten failed');
        addLinkItem(data.shortUrl);
        longUrlInput.value=''; customAlias.value=''; expiry.value=''; previewToggle.checked=false;
      }catch(e){errorMsg.textContent=e.message;}finally{loader.style.display='none'; shortenBtn.disabled=false;}
    });

    function addLinkItem(short){
      const container=document.createElement('div'); container.className='link-item';
      const info=document.createElement('div'); info.className='link-info';
      info.innerHTML=`<a href='#'>${short}</a>`;
      const actions=document.createElement('div'); actions.className='actions';
      const qr=new QRious({value:short,size:80}); const qrImg=document.createElement('img'); qrImg.src=qr.toDataURL(); qrImg.className='qr-img';
      const copyBtn=document.createElement('button'); copyBtn.textContent='Copy'; copyBtn.onclick=()=>navigator.clipboard.writeText(short);
      const qrBtn=document.createElement('button'); qrBtn.textContent='Download QR'; qrBtn.onclick=()=>downloadQR(qr.toDataURL());
      actions.append(qrImg, copyBtn, qrBtn);
      container.append(info, actions);
      linkList.prepend(container);

      info.addEventListener('click',(e)=>{
        e.preventDefault(); actions.style.display = 'flex';
        // show spinner and redirect
        spinnerScreen.classList.add('active');
        setTimeout(()=>{ window.location.href = short; }, 1000);
      });
    }
    function downloadQR(dataUrl){ const a=document.createElement('a'); a.href=dataUrl; a.download='qr-code.png'; a.click(); }
  </script>
</body>
</html>
